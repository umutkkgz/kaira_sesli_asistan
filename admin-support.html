<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KΔIRA | Canlı Destek Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-black via-slate-900 to-black min-h-screen text-white">
  <div class="max-w-5xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">Canlı Destek Admin</h1>
      <div class="flex gap-3">
        <a href="index.html" class="bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 px-4 py-2 rounded-lg shadow">Anasayfa</a>
        <a href="profile.html" class="bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 px-4 py-2 rounded-lg shadow">Profil</a>
      </div>
    </div>

    <!-- Login Card -->
    <div id="login-card" class="max-w-md mx-auto bg-gray-900/70 border border-gray-700 rounded-2xl p-6">
      <div class="text-white font-semibold mb-2">Yönetici Girişi</div>
      <div class="text-gray-400 text-sm mb-3">Lütfen admin token/şifrenizi giriniz.</div>
      <input id="adm-token" type="password" placeholder="Admin Token (varsayılan: 210858)" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white" />
      <label class="mt-2 inline-flex items-center gap-2 text-sm text-gray-300"><input id="adm-remember" type="checkbox" class="rounded" checked />Beni hatırla</label>
      <button id="adm-login" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded">Giriş</button>
      <div id="adm-msg" class="text-sm h-5 mt-2 text-rose-400"></div>
    </div>

    <!-- Console -->
    <div id="console" class="hidden grid md:grid-cols-3 gap-4 mt-6">
      <div class="md:col-span-1 bg-gray-900/70 border border-gray-700 rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold">Sohbetler</div>
          <button id="refresh" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 px-2 py-1 rounded">Yenile</button>
        </div>
        <div class="flex gap-2 mb-2">
          <button id="tab-active" class="px-2 py-1 text-xs rounded bg-emerald-700 text-white">Aktif</button>
          <button id="tab-archived" class="px-2 py-1 text-xs rounded bg-slate-700 text-slate-200">Arşiv</button>
        </div>
        <div id="archived-search-wrap" class="hidden mb-2">
          <input id="archived-search" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm text-white" placeholder="Arşivde ara..." />
        </div>
        <ul id="chat-list" class="space-y-2 text-sm"></ul>
        <ul id="archived-list" class="hidden space-y-2 text-sm"></ul>
      </div>
      <div class="md:col-span-2 bg-gray-900/70 border border-gray-700 rounded-2xl p-4 flex flex-col">
        <div id="chat-header" class="text-sm text-gray-300 mb-2 flex items-center justify-between">
          <div>Sohbet yok</div>
          <div class="flex items-center gap-2">
            <button id="close-chat" class="hidden text-xs bg-rose-700 hover:bg-rose-800 text-white px-2 py-1 rounded">Sohbeti Kapat</button>
            <button id="export-chat" class="hidden text-xs bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 px-2 py-1 rounded">Dışa Aktar</button>
            <label class="text-xs text-gray-400 inline-flex items-center gap-1">
              <input id="watch-all" type="checkbox" class="rounded" /> Tüm sohbetler için bildirim
            </label>
          </div>
        </div>
        <div id="history" class="flex-1 overflow-y-auto space-y-2 bg-black/30 rounded p-3"></div>
        <div class="mt-3 flex gap-2">
          <input id="reply" placeholder="Yanıt yazın..." class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white" />
          <button id="send" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded">Gönder</button>
        </div>
        <div id="send-msg" class="text-sm h-5 mt-1"></div>
      </div>
    </div>
  </div>

  <script>
    if (!window.API_PROXY_BASE) {
      try { window.API_PROXY_BASE = localStorage.getItem('kaira_api_base') || ''; } catch(_){ }
    }
  </script>
  <script type="module">
    const API = ()=> (window.API_PROXY_BASE || '').replace(/\/$/, '');
    const DEFAULT_ADMIN_TOKEN = '210858';
    const tokenKey = 'support_admin_token';
    const rememberEl = document.getElementById('adm-remember');
    const getTok = ()=> sessionStorage.getItem(tokenKey) || localStorage.getItem(tokenKey) || '';

    const loginCard = document.getElementById('login-card');
    const consoleEl = document.getElementById('console');
    const loginBtn = document.getElementById('adm-login');
    const tokenEl = document.getElementById('adm-token');
    const admMsg = document.getElementById('adm-msg');
    const listEl = document.getElementById('chat-list');
    const archivedListEl = document.getElementById('archived-list');
    const tabActive = document.getElementById('tab-active');
    const tabArchived = document.getElementById('tab-archived');
    const archivedSearchWrap = document.getElementById('archived-search-wrap');
    const archivedSearch = document.getElementById('archived-search');
    const historyEl = document.getElementById('history');
    const headerEl = document.getElementById('chat-header');
    const sendInput = document.getElementById('reply');
    const sendBtn = document.getElementById('send');
    const sendMsg = document.getElementById('send-msg');
    const refreshBtn = document.getElementById('refresh');
    const watchAll = document.getElementById('watch-all');

    let currentChat = null;
    let lastSeenTs = {}; // chat_id -> last seen ts
    let audioCtx = null;

    function ensureAudio(){ if (!audioCtx) try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(_){ } }
    function beep(){ try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=880; g.gain.value=0.05; o.start(); setTimeout(()=>{ try{o.stop();}catch(_){ } }, 180); }catch(_){ }
    }
    async function ensureNotifyPermission(){ try{ if (!('Notification' in window)) return false; if (Notification.permission==='granted') return true; if (Notification.permission!=='denied'){ const p = await Notification.requestPermission(); return p==='granted'; } return false; }catch(_){ return false; } }
    function notify(title, body, data){ try{ if (!('Notification' in window)) return; if (Notification.permission==='granted'){ const n = new Notification(title, { body, data }); n.onclick = ()=>{ try{ window.focus(); }catch(_){ } if (n.data && n.data.chat_id) { openChatForId(n.data.chat_id); } }; beep(); } }catch(_){ }
    }
    async function openChatForId(chatId){
      await loadActive();
      const items = Array.from(document.querySelectorAll('#chat-list li'));
      const li = items.find(x => (x.textContent||'').startsWith(chatId));
      if (li) li.click();
    }

    let wsAdmin = null;
    function setLoggedIn(state){ loginCard.classList.toggle('hidden', state); consoleEl.classList.toggle('hidden', !state); }
    function connectAdminWS(){
      try{ if (wsAdmin) { wsAdmin.close(); wsAdmin=null; } }catch(_){ }
      const tok = getTok(); if (!tok) return;
      let base = API(); let origin = base || location.origin; try{ const u = new URL(origin); u.protocol = (u.protocol==='https:')? 'wss:':'ws:'; u.pathname = (u.pathname.endsWith('/')? u.pathname.slice(0,-1):u.pathname) + '/ws/support-admin'; u.search = `token=${encodeURIComponent(tok)}`; origin = u.toString(); }catch(_){ const proto = location.protocol==='https:'?'wss:':'ws:'; origin = `${proto}//${location.host}/ws/support-admin?token=${encodeURIComponent(tok)}`; }
      wsAdmin = new WebSocket(origin);
      wsAdmin.onmessage = async (ev)=>{
        try{
          const evt = JSON.parse(ev.data);
          if (evt && evt.channel==='support'){
            if (evt.event==='message'){
              if (currentChat && evt.chat_id===currentChat){
                await refreshHistory();
              } else {
                notify(`Yeni mesaj (${evt.chat_id})`, String(evt.text||''), { chat_id: evt.chat_id });
              }
            } else if (evt.event==='join' || evt.event==='left' || evt.event==='closed'){
              await loadActive();
            }
          }
        }catch(_){ }
      };
      wsAdmin.onopen = ()=>{};
      wsAdmin.onclose = ()=>{ wsAdmin=null; };
      wsAdmin.onerror = ()=>{};
    }


    async function tryFetch(url){
      const full = `${API()}${url}`;
      const tok = getTok();
      const headers = { 'ngrok-skip-browser-warning':'true' };
      if (tok) headers['X-Admin-Token'] = tok;
      const res = await fetch(full, { headers });
      return res;
    }
    async function loadActive(){
      listEl.innerHTML='';
      const tok = getTok();
      const res = await tryFetch(`/api/support/active?token=${encodeURIComponent(tok)}`);
      if (!res.ok){ admMsg.textContent = 'Token geçersiz'; setLoggedIn(false); return; }
      const j = await res.json();
      (j.active||[]).forEach(item => {
        const li = document.createElement('li');
        li.className = 'p-2 rounded bg-slate-800/60 hover:bg-slate-800 cursor-pointer';
        li.textContent = `${item.chat_id} • ${item.name || ''} ${item.email ? ' • '+item.email : ''}`;
        li.addEventListener('click', ()=> openChat(item.chat_id, item));
        listEl.appendChild(li);
      });
    }

    async function loadArchived(q){
      archivedListEl.innerHTML='';
      const tok = getTok();
      // Preferred unified endpoint
      let url = `/api/support/chats?status=closed&limit=100&token=${encodeURIComponent(tok)}`;
      if (q && q.trim()) url += `&search=${encodeURIComponent(q.trim())}`;
      let res = await tryFetch(url);
      if (!res.ok){
        // Fallback legacy endpoints
        const fallback = q && q.trim() ? `/api/support/search?q=${encodeURIComponent(q.trim())}&token=${encodeURIComponent(tok)}` : `/api/support/archived?token=${encodeURIComponent(tok)}&limit=100`;
        res = await tryFetch(fallback);
      }
      if (!res.ok) return;
      const j = await res.json();
      const items = (j.chats || j.results || j.archived || []);
      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'p-2 rounded bg-slate-800/40 hover:bg-slate-800/60 cursor-pointer';
        const meta = item.meta || item;
        const id = item.chat_id || item.id || '';
        const nm = meta.name || ''; const em = meta.email || '';
        const last = meta.last_text || item.last_text || '';
        li.textContent = `${id} • ${nm}${em?(' • '+em):''}${last?(' • '+last.slice(0,40)) : ''}`;
        li.addEventListener('click', ()=> openChat(id, meta));
        archivedListEl.appendChild(li);
      });
    }
    async function openChat(chatId, meta){
      currentChat = chatId;
      headerEl.querySelector('div').textContent = `Sohbet: ${chatId} ${(meta && meta.name ? ' • '+meta.name : '')} ${(meta && meta.email ? ' • '+meta.email : '')} ${(meta && meta.ip ? ' • '+meta.ip : '')}`;
      document.getElementById('close-chat').classList.remove('hidden');
      document.getElementById('export-chat').classList.remove('hidden');
      historyEl.innerHTML = '';
      await refreshHistory();
    }
    async function refreshHistory(){
      if (!currentChat) return;
      const tok = getTok();
      const res = await tryFetch(`/api/support/history/${encodeURIComponent(currentChat)}?token=${encodeURIComponent(tok)}`);
      if (!res.ok) return;
      const j = await res.json();
      historyEl.innerHTML = '';
      let newest = lastSeenTs[currentChat] || 0;
      (j.history||[]).forEach(m => {
        const d = document.createElement('div');
        const align = m.sender === 'admin' ? 'self-end bg-emerald-700/40 text-emerald-100' : 'self-start bg-slate-700 text-white';
        d.className = `max-w-[75%] px-3 py-2 rounded-lg text-sm ${align}`;
        const dt = new Date((m.ts||0)*1000).toLocaleString();
        d.textContent = `[${dt}] ${m.text}`;
        historyEl.appendChild(d);
        if ((m.ts||0) > newest) newest = m.ts || newest;
      });
      historyEl.scrollTop = historyEl.scrollHeight;
      // Bildirim: yeni client mesajı varsa, odak dışındayken haber ver
      const prev = lastSeenTs[currentChat] || 0;
      if (prev && newest>prev){
        const lastMsg = (j.history||[]).slice().reverse().find(x=>x.sender!=='admin');
        if (lastMsg && document.hidden){ notify('Yeni canlı destek mesajı', String(lastMsg.text||'')); }
      }
      lastSeenTs[currentChat] = newest;
    }
    async function send(){
      sendMsg.textContent='';
      if (!currentChat) { sendMsg.textContent='Sohbet seçin'; return; }
      const t = (sendInput.value||'').trim(); if (!t) return;
      try{
        const tok = getTok();
        const fd = new FormData(); fd.append('chat_id', currentChat); fd.append('text', t); fd.append('token', tok);
        const res = await fetch(`${API()}/api/support/send`, { method:'POST', body: fd });
        if (!res.ok){ sendMsg.textContent='Gönderilemedi'; return; }
        sendInput.value='';
        await refreshHistory();
      }catch(e){ sendMsg.textContent = 'Hata: ' + (e && e.message || e); }
    }

    loginBtn.addEventListener('click', async ()=>{
      admMsg.textContent='';
      const tok = tokenEl.value.trim(); if (!tok){ admMsg.textContent='Token gerekli'; return; }
      // Tokenı geçerli mi? aktif listeden deneyelim
      const res = await tryFetch(`/api/support/active?token=${encodeURIComponent(tok)}`);
      if (!res.ok){ if (res.status !== 404 && res.status !== 501){ admMsg.textContent='Token hatalı veya erişim yok'; return; } }
      const remember = !!rememberEl.checked;
      try{ (remember ? localStorage : sessionStorage).setItem(tokenKey, tok); }catch(_){ }
      setLoggedIn(true);
      try{ await loadActive(); }catch(_){ }
      await ensureNotifyPermission();
      connectAdminWS();
    });
    // Tabs
    let tabMode = 'active';
    function switchTab(mode){
      tabMode = mode;
      const on = (el)=>{ el.classList.remove('bg-slate-700','text-slate-200'); el.classList.add('bg-emerald-700','text-white'); };
      const off = (el)=>{ el.classList.remove('bg-emerald-700','text-white'); el.classList.add('bg-slate-700','text-slate-200'); };
      if (mode==='active'){ on(tabActive); off(tabArchived); listEl.classList.remove('hidden'); archivedListEl.classList.add('hidden'); archivedSearchWrap.classList.add('hidden'); loadActive(); }
      else { on(tabArchived); off(tabActive); archivedListEl.classList.remove('hidden'); listEl.classList.add('hidden'); archivedSearchWrap.classList.remove('hidden'); loadArchived(archivedSearch.value); }
    }
    tabActive.addEventListener('click', ()=> switchTab('active'));
    tabArchived.addEventListener('click', ()=> switchTab('archived'));
    archivedSearch.addEventListener('input', ()=>{ if (tabMode==='archived') loadArchived(archivedSearch.value); });
    refreshBtn.addEventListener('click', ()=>{ if (tabMode==='active') loadActive(); else loadArchived(archivedSearch.value); });
    sendBtn.addEventListener('click', send);
    sendInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

    // Auto login: if no stored token, use DEFAULT_ADMIN_TOKEN
    (async ()=>{
      let tok = getTok();
      if (!tok && DEFAULT_ADMIN_TOKEN){
        try{ localStorage.setItem(tokenKey, DEFAULT_ADMIN_TOKEN); tok = DEFAULT_ADMIN_TOKEN; }catch(_){ }
      }
      if (tok){ setLoggedIn(true); switchTab('active'); await ensureNotifyPermission(); connectAdminWS(); }
    })();
    // Periodically refresh history for open chat
    setInterval(refreshHistory, 2000);
    // Optionally watch all chats for new messages (light polling)
    setInterval(async ()=>{
      try{
        if (!watchAll.checked) return;
        await loadActive();
        const tok = getTok();
        const items = Array.from(document.querySelectorAll('#chat-list li'));
        for (const li of items){
          const text = li.textContent || '';
          const chatId = text.split(' • ')[0].trim();
          if (!chatId) continue;
          const res = await fetch(`${API()}/api/support/history/${encodeURIComponent(chatId)}?token=${encodeURIComponent(tok)}`);
          if (!res.ok) continue; const j = await res.json();
          const hist = j.history||[]; if (!hist.length) continue;
          const latest = hist[hist.length-1];
          const prev = lastSeenTs[chatId] || 0;
          const newestTs = latest.ts || prev;
          if (newestTs > prev){
            // yeni mesaj; admin değilse duyur
            if (latest.sender !== 'admin'){ notify(`Yeni mesaj (${chatId})`, String(latest.text||'')); }
            lastSeenTs[chatId] = newestTs;
          }
        }
      }catch(_){ }
    }, 6000);

    // Close and export actions
    document.getElementById('close-chat').addEventListener('click', async ()=>{
      if (!currentChat) return;
      const tok = getTok();
      const fd = new FormData(); fd.append('chat_id', currentChat); fd.append('token', tok);
      const res = await fetch(`${API()}/api/support/close`, { method:'POST', body: fd });
      if (res.ok){ await loadActive(); historyEl.innerHTML=''; headerEl.querySelector('div').textContent='Sohbet yok'; currentChat=null; }
    });
    document.getElementById('export-chat').addEventListener('click', async ()=>{
      if (!currentChat) return;
      const tok = getTok(); const res = await tryFetch(`/api/support/history/${encodeURIComponent(currentChat)}?token=${encodeURIComponent(tok)}`);
      if (!res.ok) return; const j = await res.json();
      const blob = new Blob([JSON.stringify(j, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `support_${currentChat}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
