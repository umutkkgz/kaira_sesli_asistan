<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIRA - Sesli Asistan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            overflow: hidden;
        }

        #space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .glass-container {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 80px rgba(0, 191, 255, 0.2);
        }

        #chat-container::-webkit-scrollbar { width: 4px; }
        #chat-container::-webkit-scrollbar-thumb { background-color: rgba(75, 85, 99, 0.8); border-radius: 20px; }

        .user-bubble {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            align-self: flex-end;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25);
        }
        .assistant-bubble {
            background: rgba(55, 65, 81, 0.9);
            color: #E5E7EB;
            align-self: flex-start;
        }

        .mic-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }
        .mic-wrapper::before {
            content: '';
            position: absolute;
            width: 110px;
            height: 110px;
            background: radial-gradient(circle, rgba(0, 191, 255, 0.35) 0%, rgba(0, 191, 255, 0) 65%);
            border-radius: 50%;
            z-index: 0;
            animation: aurora 5s infinite linear;
        }
        #mic-btn { z-index: 1; animation: breathe 3s infinite ease-in-out; }
        
        @keyframes aurora {
            0% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 0.7; }
        }
        
        @keyframes breathe {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(0, 191, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(0, 191, 255, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(0, 191, 255, 0.3); }
        }

        .is-listening { animation: pulse 1.5s infinite !important; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8); }
            70% { box-shadow: 0 0 0 30px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-bubble, .assistant-bubble { animation: fadeIn 0.4s ease-out; }

        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af; display: inline-block; border-radius: 50%;
            animation: bounce 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-white p-4">

    <canvas id="space-bg"></canvas>

    <div class="w-full max-w-2xl mx-auto glass-container rounded-2xl shadow-2xl flex flex-col p-6" style="height: 90vh;">
        
        <div class="relative text-center border-b border-gray-700/50 pb-4 mb-4">
            <h1 class="text-2xl font-bold text-gray-200 tracking-wider" style="text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);">KAIRA</h1>
            <p id="status" class="text-sm text-cyan-400 h-5 transition-all duration-300">Konuşmak için mikrofon simgesine dokunun</p>
            <button id="clear-chat-btn" title="Sohbeti Temizle" class="absolute top-1 right-0 text-gray-500 hover:text-white transition-colors p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
        </div>

        <div id="chat-container" class="flex-grow overflow-y-auto pr-2 flex flex-col gap-4"></div>

        <div class="pt-4 mt-4 border-t border-gray-700/50 flex flex-col items-center">
            <div class="mic-wrapper">
                <button id="mic-btn" class="bg-blue-600 hover:bg-blue-700 transition-all duration-300 rounded-full w-16 h-16 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7v1h6v-1h-2v-2.07z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>
    </div>

    <audio id="player" class="hidden"></audio>

    <script>
        // --- Gelişmiş Arka Plan Animasyonu ---
        const canvas = document.getElementById('space-bg');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let mouse = { x: null, y: null };

        function setCanvasSize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = [];
            const particleCount = (canvas.width * canvas.height) / 8000;
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    originX: Math.random() * canvas.width, originY: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1, speed: Math.random() * 0.5 + 0.1,
                    color: `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`
                });
            }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                if (mouse.x !== null) {
                    let dx = mouse.x - p.x; let dy = mouse.y - p.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 150) { p.x -= dx / 10 * p.speed; p.y -= dy / 10 * p.speed; } 
                    else { p.x += (p.originX - p.x) * 0.01 * p.speed; p.y += (p.originY - p.y) * 0.01 * p.speed; }
                }
            });
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
        window.addEventListener('mouseout', () => { mouse.x = null; mouse.y = null; });
        window.addEventListener('resize', () => { setCanvasSize(); createParticles(); });
        setCanvasSize(); createParticles(); animateParticles();

        // --- SESLİ ASİSTAN KODU ---
        // YENİ: API Adresi eklendi
        const API_BASE = "https://aed4147b5a11.ngrok-free.app"; 
        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status');
        const player = document.getElementById('player');
        const chatContainer = document.getElementById('chat-container');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        let chatHistory = [];

        // YENİ: Kullanıcı ID'si oluşturma ve saklama
        function getUserId() {
            let id = localStorage.getItem('kaira_uid');
            if (!id) {
                id = crypto.randomUUID ? crypto.randomUUID() : `user_${Date.now()}${Math.random()}`;
                localStorage.setItem('kaira_uid', id);
            }
            return id;
        }
        const USER_ID = getUserId();

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition(); recognition.continuous = false; recognition.lang = 'tr-TR'; recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; micBtn.classList.remove('breathe'); micBtn.classList.add('is-listening'); statusEl.textContent = 'Dinliyorum...'; };
            recognition.onend = () => { isRecording = false; micBtn.classList.remove('is-listening'); micBtn.classList.add('breathe'); if (statusEl.textContent === 'Dinliyorum...') statusEl.textContent = 'Konuşmak için mikrofon simgesine dokunun'; };
            recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; addMessageToChat(transcript, 'user'); getAIResponse(transcript); };
            recognition.onerror = (event) => { console.error("Speech Recognition Error:", event.error); statusEl.textContent = `Hata: ${event.error}`; };
        } else {
            statusEl.textContent = "Tarayıcınız konuşma tanımayı desteklemiyor."; micBtn.disabled = true;
        }
        
        let audioUnlocked = false;
        function unlockAudio() { if (audioUnlocked) return; player.muted = true; player.play().catch(() => {}); player.muted = false; audioUnlocked = true; }

        micBtn.addEventListener('click', () => { unlockAudio(); if (isRecording) { recognition.stop(); } else { recognition.start(); } });
        player.onended = () => { statusEl.textContent = 'Konuşmak için mikrofon simgesine dokunun'; micBtn.disabled = false; };
        
        clearChatBtn.addEventListener('click', () => {
            chatHistory = []; localStorage.removeItem('kaira_chat_history'); chatContainer.innerHTML = '';
            addMessageToChat('Merhaba! Size nasıl yardımcı olabilirim?', 'assistant');
        });

        function base64ToBlobUrl(base64, contentType = 'audio/wav') {
            const byteCharacters = atob(base64); const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512); const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) { byteNumbers[i] = slice.charCodeAt(i); }
                const byteArray = new Uint8Array(byteNumbers); byteArrays.push(byteArray);
            }
            return URL.createObjectURL(new Blob(byteArrays, { type: contentType }));
        }

        function showTypingIndicator() {
            const bubble = document.createElement('div');
            bubble.id = 'typing-indicator';
            bubble.className = 'p-3 rounded-xl max-w-lg assistant-bubble';
            bubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function getAIResponse(text, { angry = false } = {}) {
            statusEl.textContent = "KAIRA düşünüyor…";
            micBtn.disabled = true;
            showTypingIndicator();

            const fd = new FormData();
            fd.append("text", (text || "").trim());
            fd.append("angry", angry ? "true" : "false");
            // YENİ: Sohbet geçmişi ve kullanıcı ID'si sunucuya gönderiliyor
            const lastHistory = chatHistory.slice(-10); fd.append("history", JSON.stringify(lastHistory)); // Son 10 mesajı gönder
            fd.append("user_id", USER_ID);

            const ctrl = new AbortController();
            const to = setTimeout(() => ctrl.abort(), 300_000); // 5 dk zaman aşımı

            try {
                const res = await fetch(`${API_BASE}/api/tts`, { method: "POST", body: fd, signal: ctrl.signal });
                removeTypingIndicator();
                if (!res.ok) { const txt = await res.text().catch(() => ""); throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt}`); }
                const data = await res.json();
                if (!data.audio_data) { throw new Error("API yanıtında 'audio_data' alanı bulunamadı."); }
                
                const audioUrl = base64ToBlobUrl(data.audio_data);
                if (player.previousUrl) { URL.revokeObjectURL(player.previousUrl); }
                player.previousUrl = audioUrl;
                player.src = audioUrl;
                await player.play().catch((e) => console.error("Ses oynatılamadı:", e));
                statusEl.textContent = 'Cevap oynatılıyor...';

                const out = data.text_response ?? data.clean_text ?? "";
                addMessageToChat(out, 'assistant');

                return data;
            } catch (err) {
                removeTypingIndicator();
                console.error(err);
                const errorMessage = "Hata: " + (err?.message || err);
                statusEl.textContent = errorMessage;
                addMessageToChat(errorMessage, 'assistant');
                micBtn.disabled = false;
                throw err;
            } finally {
                clearTimeout(to);
            }
        }

        function addMessageToChat(text, sender) {
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl max-w-lg ${sender === 'user' ? 'user-bubble' : 'assistant-bubble'}`;
            bubble.textContent = text;
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (!isLoadingHistory && sender) {
                chatHistory.push({ role: sender, content: text });
                localStorage.setItem('kaira_chat_history', JSON.stringify(chatHistory));
            }
        }

        let isLoadingHistory = false;
        function loadChatHistory() {
            isLoadingHistory = true;
            const savedHistory = localStorage.getItem('kaira_chat_history');
            chatContainer.innerHTML = '';
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                chatHistory.forEach(message => addMessageToChat(message.content, message.role));
            } else {
                 addMessageToChat('Merhaba! Size nasıl yardımcı olabilirim?', 'assistant');
            }
            isLoadingHistory = false;
        }

        document.addEventListener('DOMContentLoaded', loadChatHistory);

    </script>
</body>
</html>
