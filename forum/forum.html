<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaira Forumları</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        /* Aktif kategori için stil */
        .category-item.active {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Prose stillerini daha modern hale getirelim */
        .prose code {
            background-color: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .prose pre {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
        }
        .prose blockquote {
            border-left-color: #4f46e5;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- ANA KONTEYNER -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-8xl">

        <!-- HEADER -->
        <header class="bg-white rounded-xl shadow-md p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V4a2 2 0 012-2h6.172a2 2 0 011.414.586l3.828 3.828A2 2 0 0117 8z"></path></svg>
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">Kaira Forumları</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="open-new-thread-modal-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105 flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span class="hidden md:block">Yeni Konu Aç</span>
                </button>
                <!-- Bildirimler -->
                 <div class="relative">
                    <svg class="w-7 h-7 text-gray-500 hover:text-gray-800 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                </div>
                <!-- Kullanıcı Avatarı -->
                <img src="https://placehold.co/40x40/7c3aed/ffffff?text=U" alt="Kullanıcı Avatarı" class="w-10 h-10 rounded-full cursor-pointer">
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6">
            <!-- SOL KENAR ÇUBUĞU - KATEGORİLER -->
            <aside class="col-span-12 md:col-span-3">
                <div class="bg-white rounded-xl shadow-md p-4">
                    <h3 class="font-bold text-lg mb-4">Kategoriler</h3>
                    <ul id="categories-list" class="space-y-2">
                        <!-- Kategoriler JS ile dinamik olarak yüklenecek -->
                    </ul>
                </div>
            </aside>

            <!-- ANA İÇERİK ALANI -->
            <div class="col-span-12 md:col-span-9">
                <!-- ============================================= -->
                <!-- ===== FORUM LİSTE GÖRÜNÜMÜ (ANA SAYFA) ===== -->
                <!-- ============================================= -->
                <main id="forum-list-view" class="view">
                    <!-- ARAMA VE FİLTRELEME -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                         <div class="flex flex-col md:flex-row gap-4">
                             <div class="relative flex-grow">
                                 <input type="text" placeholder="Forumda ara..." class="w-full p-3 pl-10 bg-gray-100 border border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                 <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                             </div>
                             <select class="p-3 bg-gray-100 border border-transparent rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                 <option>En Yeni</option>
                                 <option>En Popüler</option>
                                 <option>En Çok Yanıtlanan</option>
                             </select>
                         </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md">
                        <div class="p-4 border-b border-gray-200">
                            <h2 id="list-title" class="text-lg font-semibold">Son Tartışmalar</h2>
                        </div>
                        <div id="threads-container" class="divide-y divide-gray-200">
                            <!-- Konular JS ile dinamik olarak buraya yüklenecek -->
                        </div>
                    </div>
                    <!-- SAYFALAMA -->
                     <div class="mt-6 flex justify-center items-center space-x-2">
                        <button class="px-4 py-2 bg-white rounded-md shadow-sm text-gray-600 hover:bg-gray-50">&laquo; Önceki</button>
                        <button class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm">1</button>
                        <button class="px-4 py-2 bg-white rounded-md shadow-sm text-gray-600 hover:bg-gray-50">2</button>
                        <button class="px-4 py-2 bg-white rounded-md shadow-sm text-gray-600 hover:bg-gray-50">3</button>
                        <button class="px-4 py-2 bg-white rounded-md shadow-sm text-gray-600 hover:bg-gray-50">Sonraki &raquo;</button>
                    </div>
                </main>

                <!-- ======================================= -->
                <!-- ===== KONU DETAY GÖRÜNÜMÜ (GİZLİ) ===== -->
                <!-- ======================================= -->
                <main id="thread-detail-view" class="view hidden opacity-0">
                    <div class="mb-4">
                        <button id="back-to-list-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            <span id="back-to-list-text">Tüm Konulara Geri Dön</span>
                        </button>
                    </div>
                    
                    <div id="thread-detail-content">
                        <!-- Konu detayı JS ile dinamik olarak buraya yüklenecek -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- =================================================== -->
    <!-- ===== YENİ KONU OLUŞTURMA MODALI (PENCERE) ===== -->
    <!-- =================================================== -->
    <div id="new-thread-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 transform scale-95 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Yeni Bir Konu Başlat</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="new-thread-form">
                <div class="mb-4">
                    <label for="thread-title" class="block text-sm font-medium text-gray-700 mb-1">Konu Başlığı</label>
                    <input type="text" id="thread-title" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Konunuzu özetleyen bir başlık girin..." required>
                </div>
                 <div class="mb-4">
                    <label for="thread-category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="thread-category" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                        <!-- Kategoriler JS ile yüklenecek -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="thread-message" class="block text-sm font-medium text-gray-700 mb-1">Mesajınız</label>
                    <!-- Sahte Zengin Metin Editörü Araç Çubuğu -->
                    <div class="border border-gray-300 rounded-t-lg bg-gray-50 p-2 flex space-x-2">
                        <button type="button" class="p-1 rounded hover:bg-gray-200">B</button>
                        <button type="button" class="p-1 rounded hover:bg-gray-200">I</button>
                        <button type="button" class="p-1 rounded hover:bg-gray-200">&lt;/&gt;</button>
                        <button type="button" class="p-1 rounded hover:bg-gray-200">Link</button>
                    </div>
                    <textarea id="thread-message" rows="8" class="w-full p-3 border-l border-r border-b border-gray-300 rounded-b-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Detayları buraya yazın..." required></textarea>
                </div>
                <div class="text-right">
                    <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">Konuyu Oluştur</button>
                </div>
            </form>
        </div>
    </div>


    
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const DEFAULT_API_BASE = 'https://53575c229bbb.ngrok-free.app';
    const storedBase = (() => {
      try { return localStorage.getItem('kaira_api_base') || ''; }
      catch (_) { return ''; }
    })();
    const apiBaseCandidate = (window.API_PROXY_BASE || storedBase || DEFAULT_API_BASE || '').trim();
    const API_BASE = apiBaseCandidate.replace(/\/$/, '');

    const elements = {
      categoriesList: document.getElementById('categories-list'),
      forumListView: document.getElementById('forum-list-view'),
      threadDetailView: document.getElementById('thread-detail-view'),
      threadsContainer: document.getElementById('threads-container'),
      threadDetailContent: document.getElementById('thread-detail-content'),
      backToListBtn: document.getElementById('back-to-list-btn'),
      backToListText: document.getElementById('back-to-list-text'),
      listTitle: document.getElementById('list-title'),
      searchInput: document.querySelector('#forum-list-view input[type="text"]'),
      sortSelect: document.querySelector('#forum-list-view select'),
      newThreadModal: document.getElementById('new-thread-modal'),
      openModalBtn: document.getElementById('open-new-thread-modal-btn'),
      closeModalBtn: document.getElementById('close-modal-btn'),
      newThreadForm: document.getElementById('new-thread-form'),
      threadCategorySelect: document.getElementById('thread-category'),
    };

    const state = {
      categories: [],
      currentCategory: 'all',
      threads: [],
      search: '',
      activeThread: null,
    };

    const escapeHtml = (str = '') => str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');

    const textToHtml = (text = '') => {
      const safe = escapeHtml(text.trim());
      if (!safe) return '';
      return '<p>' + safe.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
    };

    const formatDate = (iso) => {
      if (!iso) return '';
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return iso;
      return dt.toLocaleString('tr-TR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit',
      });
    };

    const currentUser = () => {
      try {
        return JSON.parse(localStorage.getItem('kaira_user') || 'null') || {};
      } catch (_) {
        return {};
      }
    };

    const generateAvatar = (name = '') => {
      const letter = (name || '?').trim().charAt(0).toUpperCase() || 'K';
      return `https://placehold.co/48x48/6366f1/ffffff?text=${encodeURIComponent(letter)}`;
    };

    const joinUrl = (base, path) => {
      if (!base) return path;
      if (/^https?:\/\//i.test(path)) return path;
      return `${base}${path}`;
    };

    const apiGet = async (path, params = {}) => {
      const urlString = joinUrl(API_BASE, path);
      const url = new URL(urlString, window.location.origin);
      Object.entries(params).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== '') {
          url.searchParams.append(key, value);
        }
      });
      const res = await fetch(url.toString());
      if (!res.ok) {
        const detail = await res.text();
        throw new Error(detail || 'İstek başarısız oldu');
      }
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (err) {
        throw new Error(`Forum API JSON parse error. Yanıt: ${text.slice(0,120)}`);
      }
    };

    const apiPost = async (path, payload) => {
      const urlString = joinUrl(API_BASE, path);
      const res = await fetch(urlString, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const detail = await res.text();
        throw new Error(detail || 'İşlem başarısız oldu');
      }
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (err) {
        throw new Error(`Forum API JSON parse error. Yanıt: ${text.slice(0,120)}`);
      }
    };

    const renderCategories = () => {
      elements.categoriesList.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.categories.forEach((category) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <a href="#" class="block p-2 rounded-md hover:bg-gray-100 category-item ${category.slug === state.currentCategory ? 'active' : ''}" data-category-id="${category.slug}">
            ${escapeHtml(category.name)}
          </a>`;
        frag.appendChild(li);
      });
      elements.categoriesList.appendChild(frag);

      // Yeni konu formu için seçenekler
      elements.threadCategorySelect.innerHTML = '';
      state.categories.filter((c) => c.slug !== 'all').forEach((category) => {
        const opt = document.createElement('option');
        opt.value = category.slug;
        opt.textContent = category.name;
        elements.threadCategorySelect.appendChild(opt);
      });
    };

    const renderThreadList = () => {
      const container = elements.threadsContainer;
      container.innerHTML = '';
      if (!state.threads.length) {
        container.innerHTML = '<p class="p-4 text-center text-gray-500">Bu kategoride henüz konu yok.</p>';
        return;
      }
      const frag = document.createDocumentFragment();
      state.threads.forEach((thread) => {
        const div = document.createElement('div');
        div.className = 'thread-item p-4 flex items-start space-x-4 hover:bg-gray-50 cursor-pointer';
        div.dataset.threadId = thread.id;
        div.innerHTML = `
          <img src="${thread.author_avatar || generateAvatar(thread.author_name)}" alt="Avatar" class="w-12 h-12 rounded-full flex-shrink-0">
          <div class="flex-grow">
            <h3 class="font-semibold text-gray-900">${escapeHtml(thread.title)}</h3>
            <div class="text-xs text-gray-500 mt-2">
              <span>${escapeHtml(thread.author_name || 'Anonim')}</span> · <span>${formatDate(thread.created_at)}</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">${escapeHtml(thread.category_name || '')}</div>
          </div>`;
        frag.appendChild(div);
      });
      container.appendChild(frag);
    };

    const renderThreadDetail = ({ thread, replies }) => {
      state.activeThread = thread;
      const repliesHtml = replies.map((reply) => `
        <div class="bg-white rounded-xl shadow-sm p-5 flex space-x-4">
          <img src="${reply.author_avatar || generateAvatar(reply.author_name)}" alt="Avatar" class="w-10 h-10 rounded-full flex-shrink-0 mt-1">
          <div class="flex-grow">
            <div class="flex justify-between items-center">
              <div>
                <span class="font-semibold">${escapeHtml(reply.author_name || 'Anonim')}</span>
                <span class="text-sm text-gray-500">· ${formatDate(reply.created_at)}</span>
              </div>
            </div>
            <div class="prose max-w-none mt-2 text-gray-700">${reply.body || ''}</div>
          </div>
        </div>`).join('');

      elements.threadDetailContent.innerHTML = `
        <div class="bg-white rounded-xl shadow-md p-5">
          <h2 class="text-2xl font-bold text-gray-900">${escapeHtml(thread.title)}</h2>
          <div class="flex items-center space-x-3 mt-4 pb-4 border-b border-gray-200">
            <img src="${thread.author_avatar || generateAvatar(thread.author_name)}" alt="Avatar" class="w-12 h-12 rounded-full">
            <div>
              <div class="font-semibold">${escapeHtml(thread.author_name || 'Anonim')}</div>
              <div class="text-sm text-gray-500">${formatDate(thread.created_at)}</div>
            </div>
          </div>
          <div class="prose max-w-none mt-4 text-gray-700">${thread.body || ''}</div>
        </div>
        <div id="replies-container" class="mt-6 space-y-6">
          <h3 class="text-xl font-semibold border-b pb-2">Yanıtlar (${replies.length})</h3>
          ${repliesHtml || '<p class="text-sm text-gray-500">Henüz yanıt yok.</p>'}
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 mt-6">
          <h3 class="font-semibold mb-3">Yanıtınızı Yazın</h3>
          <form id="reply-form" class="space-y-3">
            <textarea id="reply-text" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" rows="4" placeholder="Düşüncelerinizi paylaşın..." required></textarea>
            <div class="text-right">
              <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">Yanıt Gönder</button>
            </div>
          </form>
        </div>`;

      const replyForm = document.getElementById('reply-form');
      replyForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const textArea = document.getElementById('reply-text');
        const message = textArea.value.trim();
        if (!message) return;
        try {
          const user = currentUser();
          const payload = {
            body: textToHtml(message),
            author_name: user.username || user.name || 'Misafir Kullanıcı',
            author_avatar: user.avatar || generateAvatar(user.username || user.name || message),
          };
          const data = await apiPost(`/api/forum/threads/${thread.id}/replies`, payload);
          textArea.value = '';
          renderThreadDetail(data);
        } catch (err) {
          alert(err.message);
        }
      });
    };

    const showView = (view) => {
      elements.forumListView.classList.add('hidden');
      elements.threadDetailView.classList.add('hidden');
      view.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const loadCategories = async () => {
      const data = await apiGet('/api/forum/categories');
      state.categories = [
        { id: 'all', slug: 'all', name: 'Tüm Konular' },
        ...(data.categories || []).map((c) => ({ id: c.id, slug: c.slug, name: c.name })),
      ];
      renderCategories();
    };

    const loadThreads = async () => {
      const params = {};
      if (state.currentCategory && state.currentCategory !== 'all') params.category_id = state.currentCategory;
      if (state.search) params.search = state.search;
      const data = await apiGet('/api/forum/threads', params);
      state.threads = data.threads || [];
      renderThreadList();
    };

    const loadThreadDetail = async (threadId) => {
      const data = await apiGet(`/api/forum/threads/${threadId}`);
      renderThreadDetail(data);
      const category = state.categories.find((c) => c.slug === data.thread.category_slug) || state.categories[0];
      elements.backToListText.textContent = `${category ? category.name : 'Tüm Konular'} listesine geri dön`;
      showView(elements.threadDetailView);
    };

    const handleThreadCreation = async (event) => {
      event.preventDefault();
      const title = elements.newThreadForm['thread-title'].value.trim();
      const categorySlug = elements.newThreadForm['thread-category'].value;
      const message = elements.newThreadForm['thread-message'].value;
      if (!title || !categorySlug || !message.trim()) {
        alert('Lütfen tüm alanları doldurun.');
        return;
      }
      try {
        const user = currentUser();
        const payload = {
          title,
          category_id: categorySlug,
          body: textToHtml(message),
          author_name: user.username || user.name || 'Misafir Kullanıcı',
          author_avatar: user.avatar || generateAvatar(user.username || user.name || title),
        };
        const data = await apiPost('/api/forum/threads', payload);
        elements.newThreadForm.reset();
        closeModal();
        state.currentCategory = data.thread.category_slug || 'all';
        await loadThreads();
        renderCategories();
        await loadThreadDetail(data.thread.id);
      } catch (err) {
        alert(err.message);
      }
    };

    const openModal = () => {
      elements.newThreadModal.classList.remove('hidden');
      setTimeout(() => {
        elements.newThreadModal.classList.remove('opacity-0');
        elements.newThreadModal.querySelector('.modal-content').classList.remove('scale-95');
      }, 10);
    };

    const closeModal = () => {
      elements.newThreadModal.classList.add('opacity-0');
      elements.newThreadModal.querySelector('.modal-content').classList.add('scale-95');
      setTimeout(() => elements.newThreadModal.classList.add('hidden'), 250);
    };

    // Event bindings
    elements.categoriesList.addEventListener('click', (event) => {
      const target = event.target.closest('.category-item');
      if (!target) return;
      event.preventDefault();
      state.currentCategory = target.dataset.categoryId;
      const category = state.categories.find((c) => c.slug === state.currentCategory);
      elements.listTitle.textContent = category ? category.name : 'Konular';
      renderCategories();
      loadThreads();
      showView(elements.forumListView);
    });

    elements.threadsContainer.addEventListener('click', (event) => {
      const item = event.target.closest('.thread-item');
      if (!item) return;
      loadThreadDetail(item.dataset.threadId);
    });

    elements.backToListBtn.addEventListener('click', () => {
      showView(elements.forumListView);
    });

    elements.openModalBtn.addEventListener('click', openModal);
    elements.closeModalBtn.addEventListener('click', closeModal);
    elements.newThreadModal.addEventListener('click', (event) => {
      if (event.target === elements.newThreadModal) closeModal();
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !elements.newThreadModal.classList.contains('hidden')) closeModal();
    });

    elements.newThreadForm.addEventListener('submit', handleThreadCreation);

    elements.searchInput.addEventListener('input', (event) => {
      state.search = event.target.value.trim();
      clearTimeout(elements.searchInput._debounce);
      elements.searchInput._debounce = setTimeout(loadThreads, 300);
    });

    (async () => {
      try {
        await loadCategories();
        await loadThreads();
      } catch (err) {
        alert(err.message);
      }
    })();
  });
</script>

</body>
</html>
